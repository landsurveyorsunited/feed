<!doctype html>
<html manifest="appcache.manifest">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<style>
*{margin:0;padding:0}
h2{text-align:center;background:#11CED2;color:#FFF;padding:.2em;margin:0 0 1em 0;}
body{background:#FFF;padding:0 0 2em 0;font-family:sans-serif;}
button{position:fixed;bottom:.5em;right:.5em;background:#F48;color:#FFF;border:none;font-size:2em;width:2em;height:2em;border-radius:2em;cursor: pointer;box-shadow: .02em .02em .15em #000;}
ul{list-style: none;}
li{padding:1em;}
li span{float:right;opacity:.5;display:none;}
li p{text-align:justify;overflow:hidden;}
</style>
<script>
//utilities
function unescapeEntities(txt){
	var a=document.createElement("A")
	a.innerHTML=txt;
	return a.textContent;
}
$ =function(query,e){return (e||document).querySelector(query)};
$$=function(query,e){return [].slice.call((e||document).querySelectorAll(query))}
$.get=function(url,ok_cb,ko_cb){
	var xhr = new XMLHttpRequest();
	xhr.onreadystatechange=function(){
		if(xhr.readyState!=4)return;
		if(xhr.status==200)return ok_cb(xhr.response,xhr);
		if(ko_cb)return ko_cb(xhr.response,xhr.statusText);
	};
	xhr.open('GET',url);
	xhr.send();
}
$.toNode=function(jsonML){
	var node=document.createElement(jsonML.shift());
	jsonML.forEach(function(j){
		if(j)switch(j.constructor){
			case Array :node.appendChild($.toNode(j));break;
			case Object:for(attr in j){
				if(attr.match(/^on/))node[attr]=j[attr];//event attribut
				else node.setAttribute(attr,j[attr])//other attribut
			};break;
			case String:node.appendChild(document.createTextNode(j));break;
		}
	});
	return node;
}
//////////:
function CORS(q){return 'http://allow-any-origin.appspot.com/'+q}

function updateRSS(url,ok_cb,ko_cb){
	if(localStorage[url])return ok_cb(localStorage[url]);//already in stock
	$.get(CORS(url),function(xml){
		var rss=(new DOMParser()).parseFromString(xml,"text/xml");
		var items=[].slice.call(rss.querySelectorAll('item,entry')).map(function(item){
		return{
			title:$('title',item).textContent||'',
			desc:unescapeEntities(($('description',item)||{}).textContent||''),
			href:($('guid',item)||{}).textContent || (($('link',item)||{}).attributes||{}).href,
			date:new Date(($('pubDate',item)||{}).textContent),
		}});
		ok_cb(localStorage[url]=JSON.stringify(items));
	},ko_cb);
}
function init(){
	$$('[data-fetch]').forEach(function(node){
		node.innerHTML=''
		updateRSS(node.dataset['fetch'],function(result){
			node.appendChild($.toNode(["h2",node.dataset['title']]))
			node.appendChild($.toNode(["ul"].concat(JSON.parse(result).map(function(item){
				if(item.date && (new Date()-new Date(item.date))/(1000*60*60*24)>2)return [];//hide too old (2+day) news
				return ["li",["a",{href:item.href},item.title],["span",(new Date(item.date)).toDateString()],["p",unescapeEntities(item.desc||'').replace(/<.*?>/g,' ')]]
			}))))
		})
	})
}
//;
</script>
</head>
<body onload="init()">
	<p data-format="rss" data-title="phoronix" data-fetch="http://www.phoronix.com/rss.php"></p>
	<p data-format="rss" data-title="developpez" data-fetch="http://www.developpez.com/index/rss"></p>
	<p data-format="rss" data-title="minimachines" data-fetch="http://feedpress.me/minimachines/"></p>
	<p data-format="rss" data-title="google news" data-fetch="http://news.google.com/news/feeds?hl=en&topic=t&output=rss"></p>
	<p data-format="rss" data-title="nextinpact" data-fetch="http://www.nextinpact.com/rss/news.xml"></p>
	<p data-format="rss" data-title="logic-sunrise" data-fetch="http://www.logic-sunrise.com/forums/rss/forums/1-news-fr/"></p>
	<p data-format="rss" data-title="/r/programming" data-fetch="https://www.reddit.com/r/programming/.rss"></p>
	<p data-format="rss" data-title="/r/linux" data-fetch="https://www.reddit.com/r/linux/.rss"></p>
	<p data-format="rss" data-title="lwn" data-fetch="https://lwn.net/headlines/rss"></p>
	<button onclick="window.scrollTo(0,0);for(var a in localStorage)if(a.match(/^https?:/))delete localStorage[a];init()">&#8635;</button>
</body>
</html>
